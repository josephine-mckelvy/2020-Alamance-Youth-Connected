---
title: 'Section Data'
subtitle: Pre-Test Summary; Reach (Pre/Post Test), Dosage & Fidelity (QPR)
author: "Josephine McKelvy"
date: 
output:
  html_document:
    df_print: paged

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

###################
# READ THIS FIRST #
###################

# 8/06F: You added a "not sure" option to each of the knowledge questions. That will impact the factor levels and labels. 

```
# Overview (Steps)
- import all responses (as *.csv & numeric values)
- name the variables/columns
- replace the blanks with missing (NA)
- lowercase the strings (i.e., group names)
- format the dates
- convert the "Check all that apply" into dummy variables
- factor the categorical variables
- subset the scales
- plot the diverging bar charts & save
```{r}
##################
# Clean the data #
##################

# Import data, subset and name the variables in the dataframes, remove blanks (by language)
rawppt.df <- read.csv("Participant Pre  Post Test Survey MPC.csv", stringsAsFactors = TRUE)

#English Pre/Post-Tests: subsetted dataframe
pptengl.df <- rawppt.df[2:nrow(rawppt.df),c(3,12:70,78:116)] #99 variables
names(pptengl.df) <- c("Start Date","Initials","Birthdate",
                   "Group Name", "Participant", "Time",
                   "Alamance County",
                   "Other County (text)",
                   "Grade",
                   "Race not reported",
                   "White",
                   "Black",
                   "Asian",
                   "Pacific Islander",
                   "Native American",
                   "Other Race (text)",
                   "Hispanic",
                   "Language",
                   "Other Language (text)",
                   "Gender not reported",
                   "Woman",
                   "Man",
                   "Transgender",
                   "Nonbinary/Does not identify",
                   "Other Gender (text)",
                   "Sexual Identity",
                   "Other Sexual Identity (text)",
                   "Oral Sex",
                   "Vaginal Sex",
                   "Anal Sex",
                   "Pregnancy",
                   "Sex using alcohol",
                   "Sex using drugs",
                   "Never had sex",
                   "(Duplicate hidden category)",
                   "Sex with no barrier method",
                   "Sex with no birth control",
                   "EC",
                   "IUD",
                   "Implant",
                   "Shot",
                   "Ring",
                   "Patch",
                   "Pill",
                   "Barrier Method",
                   "Not sure",
                   "Prefer not to answer",
                   "Other Method (text)",
                   "Group leader understood me",
                   "Group mates respect each other",
                   "I felt judged*",
                   "Group leader knew the material",
                   "I understood the material",
                   "Group leader made the activities fun",
                   "I felt free to speak",
                   "I felt uncomfortable participating*",
                   "Topics I will remember",
                   "Group did this well",
                   "Improvements",
                   "First name",
                   "Email address",
                   "Phone number",
                   "Future",
                   "Healthy Relationship",
                   "Dating Abuse",
                   "Consent",
                   "PrEP",
                   "abstinence-neither",
                   "abstinence-pregnancy",
                   "abstinence-STI",
                   "birth control-neither",
                   "birth control-pregnancy",
                   "birth control-STI",
                   "external condom-neither",
                   "external condom-pregnancy",
                   "external condom-STI",
                   "lambskin condom-neither",
                   "lambskin condom-pregnancy",
                   "lambskin condom-STI",
                   "internal condom-neither",
                   "internal condom-pregnancy",
                   "internal condom-STI",
                   "withdrawal-neither",
                   "withdrawal-pregnancy",
                   "withdrawal-STI",
                   "Store the condom",
                   "Open the package",
                   "Pinch the tip",
                   "Unroll the condom",
                   "Hold the base",
                   "STI infection",
                   "Water-based lubricants",
                   "EC up to 5 days",
                   "EC without prescription",
                   "Prepared to say no if not ready",
                   "Prepared to use a barrier method",
                   "Prepared to say no if no barrier method",
                   "Prepared to use birth control",
                   "Prepared to go to a doctor for birth control")
pptengl.df[pptengl.df==""] <- NA

#Spanish Pre/Post-Tests: Subsetted dataframe
pptspan.df <- rawppt.df[2:nrow(rawppt.df),c(3,118:176,184:222) ] #99 variables
names(pptspan.df) <- c("Start Date","Initials","Birthdate",
                   "Group Name", "Participant", "Time",
                   "Alamance County",
                   "Other County (text)",
                   "Grade",
                   "Race not reported",
                   "White",
                   "Black",
                   "Asian",
                   "Pacific Islander",
                   "Native American",
                   "Other Race (text)",
                   "Hispanic",
                   "Language",
                   "Other Language (text)",
                   "Gender not reported",
                   "Woman",
                   "Man",
                   "Transgender",
                   "Nonbinary/Does not identify",
                   "Other Gender (text)",
                   "Sexual Identity",
                   "Other Sexual Identity (text)",
                   "Oral Sex",
                   "Vaginal Sex",
                   "Anal Sex",
                   "Pregnancy",
                   "Sex using alcohol",
                   "Sex using drugs",
                   "Never had sex",
                   "(Duplicate hidden category)",
                   "Sex with no barrier method",
                   "Sex with no birth control",
                   "EC",
                   "IUD",
                   "Implant",
                   "Shot",
                   "Ring",
                   "Patch",
                   "Pill",
                   "Barrier Method",
                   "Not sure",
                   "Prefer not to answer",
                   "Other Method (text)",
                   "Group leader understood me",
                   "Group mates respect each other",
                   "I felt judged*",
                   "Group leader knew the material",
                   "I understood the material",
                   "Group leader made the activities fun",
                   "I felt free to speak",
                   "I felt uncomfortable participating*",
                   "Topics I will remember",
                   "Group did this well",
                   "Improvements",
                   "First name",
                   "Email address",
                   "Phone number",
                   "Future",
                   "Healthy Relationship",
                   "Dating Abuse",
                   "Consent",
                   "PrEP",
                   "abstinence-neither",
                   "abstinence-pregnancy",
                   "abstinence-STI",
                   "birth control-neither",
                   "birth control-pregnancy",
                   "birth control-STI",
                   "external condom-neither",
                   "external condom-pregnancy",
                   "external condom-STI",
                   "lambskin condom-neither",
                   "lambskin condom-pregnancy",
                   "lambskin condom-STI",
                   "internal condom-neither",
                   "internal condom-pregnancy",
                   "internal condom-STI",
                   "withdrawal-neither",
                   "withdrawal-pregnancy",
                   "withdrawal-STI",
                   "Store the condom",
                   "Open the package",
                   "Pinch the tip",
                   "Unroll the condom",
                   "Hold the base",
                   "STI infection",
                   "Water-based lubricants",
                   "EC up to 5 days",
                   "EC without prescription",
                   "Prepared to say no if not ready",
                   "Prepared to use a barrier method",
                   "Prepared to say no if no barrier method",
                   "Prepared to use birth control",
                   "Prepared to go to a doctor for birth control")
pptspan.df[pptspan.df==""] <- NA

# Lowercase the strings and format the dates
library(data.table)

#English Pre/Post-Tests: Identifiers
pptengl.df$`Group Name` <- tolower(pptengl.df$`Group Name`) 
pptengl.df$Initials <- tolower(pptengl.df$Initials)

pptengl.df$`Start Date` <- as.POSIXct(as.character(pptengl.df$`Start Date`), format = "%m/%d/%Y %H:%M:%S %p", tz="America/New_York")
pptengl.df$Birthdate <- as.Date(pptengl.df$Birthdate, "%m/%d/%Y") 
pptengl.df$PID <- paste(pptengl.df$Initials, pptengl.df$Birthdate)

#Spanish Pre/Post-Tests: Identifiers
pptspan.df$`Group Name` <- tolower(pptspan.df$`Group Name`) 
pptspan.df$Initials <- tolower(pptspan.df$Initials)

pptspan.df$`Start Date` <- as.POSIXct(as.character(pptspan.df$`Start Date`), format = "%m/%d/%Y %H:%M:%S %p", tz="America/New_York")
pptspan.df$Birthdate <- as.Date(pptspan.df$Birthdate, "%m/%d/%Y") 
pptspan.df$PID <- paste(pptspan.df$Initials, pptspan.df$Birthdate)

# Dummy the CATA variables
cleanIt <- function(vec){
  chars <- as.character(vec)
  chars[chars!=""] <- "1" #if not blank (including zeroes), replace with "one"
  chars[is.na(chars)] <- "0" #if missing, replace with zero
  chars[chars==""] <- "0" #if blank, replace with zero
  return(as.numeric(chars)) #convert values to numbers
}

#English Pre/Post-Tests: Multiple Response Dummy Variables
pptengl.df[10:15]  <- lapply(pptengl.df[10:15],  cleanIt) #pre: racial identity options
pptengl.df[20:24] <- lapply(pptengl.df[20:24], cleanIt) #pre: gender identity options
pptengl.df[34:47] <- lapply(pptengl.df[34:47], cleanIt) #pre: last time sex options
pptengl.df[68:85] <- lapply(pptengl.df[68:85], cleanIt) #both: if used correctly Qs

#Spanish Pre/Post-Tests: Multiple Response Dummy Variables
pptspan.df[10:15]  <- lapply(pptspan.df[10:15],  cleanIt) #pre: racial identity options
pptspan.df[20:24] <- lapply(pptspan.df[20:24], cleanIt) #pre: gender identity options
pptspan.df[34:47] <- lapply(pptspan.df[34:47], cleanIt) #pre: last time sex options
pptspan.df[68:85] <- lapply(pptspan.df[68:85], cleanIt) #both: if used correctly Qs

# Factor categorical variables

#English Pre-Tests: Categorical Variables - Demographics
pptengl.df$Time <- factor(pptengl.df$Time,
                    levels = c(1,2),
                    labels = c("Before", "After"))
pptengl.df$`Alamance County` <- factor(pptengl.df$`Alamance County`,
                                   levels = c(1,0),
                                   labels = c("Yes","No/Not Reported"))
pptengl.df$Grade <- factor(pptengl.df$Grade,
                   levels = c(1,2,3,4,5,6,7,9,10,11,12),
                   labels = c("6th Grade",
                              "7th Grade",
                              "8th Grade",
                              "9th Grade",
                              "10th Grade",
                              "11th Grade",
                              "12th Grade",
                              "GED Program",
                              "Technical Training or College",
                              "Not in school",
                              "Prefer not to answer"))
pptengl.df$Hispanic <- factor(pptengl.df$Hispanic,
                          levels = c(1,2,0),
                          labels = c("Hispanic/Latinx",
                                     "Non-Hispanic/Latinx",
                                     "Prefer not to answer"))
pptengl.df$Language <- factor(pptengl.df$Language,
                         levels = c(1,2,3,0),
                         labels = c("English",
                                    "Spanish",
                                    "Both",
                                    "Prefer not to answer/Other"))
pptengl.df$`Sexual Identity` <- factor(pptengl.df$`Sexual Identity`,
                         levels = c(1,2,3,4,0),
                         labels = c("LGBQ",
                                    "Straight",
                                    "Pansexual",
                                    "Not sure yet",
                                    "Prefer not to answer/Other"))
table(pptengl.df$`Sexual Identity`) #check against Survey Monkey's Question Summary

#Spanish Pre-Tests: Categorical Variables - Demographics
pptspan.df$Time <- factor(pptspan.df$Time,
                    levels = c(1,2),
                    labels = c("Before", "After"))
pptspan.df$`Alamance County` <- factor(pptspan.df$`Alamance County`,
                                   levels = c(1,0),
                                   labels = c("Yes","No/Not Reported"))
pptspan.df$Grade <- factor(pptspan.df$Grade,
                   levels = c(1,2,3,4,5,6,7,9,10,11,12),
                   labels = c("6th Grade",
                              "7th Grade",
                              "8th Grade",
                              "9th Grade",
                              "10th Grade",
                              "11th Grade",
                              "12th Grade",
                              "GED Program",
                              "Technical Training or College",
                              "Not in school",
                              "Prefer not to answer"))
pptspan.df$Hispanic <- factor(pptspan.df$Hispanic,
                          levels = c(1,2,0),
                          labels = c("Hispanic/Latinx",
                                     "Non-Hispanic/Latinx",
                                     "Prefer not to answer"))
pptspan.df$Language <- factor(pptspan.df$Language,
                         levels = c(1,2,3,0),
                         labels = c("English",
                                    "Spanish",
                                    "Both",
                                    "Prefer not to answer/Other"))
pptspan.df$`Sexual Identity` <- factor(pptspan.df$`Sexual Identity`,
                         levels = c(1,2,3,4,0),
                         labels = c("LGBQ",
                                    "Straight",
                                    "Pansexual",
                                    "Not sure yet",
                                    "Prefer not to answer/Other"))

#Pre-Tests: Experiences codebook - The labels and levels are re-ordered to how I want them to appear in the legend with "prefer not to answer" on one end or the other of the Likert scale, as opposed to the sequence in the paper survey/codebook: 1=last 30 days; 2=more than 30 days ago; 3=not sure; 4=never; 5=prefer not to answer 

labelfreq <- c("Never",
               "Not sure",
               "Prefer not to answer",
               "Within the last 30 days",
               "Ever (more than 30 days ago")

#English Pre-Tests: Categorical Variables - Experiences
pptengl.df$`Oral Sex` <- factor(pptengl.df$`Oral Sex`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptengl.df$`Vaginal Sex` <- factor(pptengl.df$`Vaginal Sex`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptengl.df$`Anal Sex` <- factor(pptengl.df$`Anal Sex`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptengl.df$Pregnancy <- factor(pptengl.df$Pregnancy,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptengl.df$`Sex using alcohol` <- factor(pptengl.df$`Sex using alcohol`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptengl.df$`Sex using drugs` <- factor(pptengl.df$`Sex using drugs`,
                                   levels = c(4,3,5,1,2),
                                   labels = labelfreq)

#Spanish Pre-Tests: Categorical Variables - Experiences
pptspan.df$`Oral Sex` <- factor(pptspan.df$`Oral Sex`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptspan.df$`Vaginal Sex` <- factor(pptspan.df$`Vaginal Sex`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptspan.df$`Anal Sex` <- factor(pptspan.df$`Anal Sex`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptspan.df$Pregnancy <- factor(pptspan.df$Pregnancy,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptspan.df$`Sex using alcohol` <- factor(pptspan.df$`Sex using alcohol`,
                         levels = c(4,3,5,1,2),
                         labels = labelfreq,
                         ordered = FALSE)
pptspan.df$`Sex using drugs` <- factor(pptspan.df$`Sex using drugs`,
                                   levels = c(4,3,5,1,2),
                                   labels = labelfreq)

#Pre/Post-Tests: Thoughts codebook - 1=disagree; 2=not sure; 3=agree; 4=not applicable to me (replaced with NA); 5=prefer not to answer; seemed to work by just omitting "prefer not to answer"

labellikert <- c("Disagree",
                 "Not Sure",
                 "Agree")

#English Pre/Post Tests: Categorical Variables - Thoughts
pptengl.df$`Prepared to say no if not ready` <- factor(pptengl.df$`Prepared to say no if not ready`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptengl.df$`Prepared to use a barrier method` <- factor(pptengl.df$`Prepared to use a barrier method`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptengl.df$`Prepared to say no if no barrier method` <- factor(pptengl.df$`Prepared to say no if no barrier method`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptengl.df$`Prepared to use birth control` <- factor(pptengl.df$`Prepared to use birth control`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptengl.df$`Prepared to go to a doctor for birth control` <- factor(pptengl.df$`Prepared to go to a doctor for birth control`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)

#Spanish Pre/Post Tests: Categorical Variables - Thoughts
pptspan.df$`Prepared to say no if not ready` <- factor(pptspan.df$`Prepared to say no if not ready`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptspan.df$`Prepared to use a barrier method` <- factor(pptspan.df$`Prepared to use a barrier method`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptspan.df$`Prepared to say no if no barrier method` <- factor(pptspan.df$`Prepared to say no if no barrier method`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptspan.df$`Prepared to use birth control` <- factor(pptspan.df$`Prepared to use birth control`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)
pptspan.df$`Prepared to go to a doctor for birth control` <- factor(pptspan.df$`Prepared to go to a doctor for birth control`,
                      levels = c(1,2,3),
                      labels = labellikert,
                      ordered = FALSE)

#Post-Tests: Group satisfaction codebook - 1=disagree; 2=not sure; 3=agree; 4=prefer not to answer 

#English Post-Tests: Categorical Variable - Satisfaction 
pptengl.df$`Group leader understood me` <- factor(pptengl.df$`Group leader understood me`,
                                              levels = c(1,2,3),
                                              labels = labellikert,
                                              ordered = FALSE)
pptengl.df$`Group mates respect each other` <- factor(pptengl.df$`Group mates respect each other`,
                                              levels = c(1,2,3),
                                              labels = labellikert,
                                              ordered = FALSE)
pptengl.df$`I felt judged*` <- factor(pptengl.df$`I felt judged`,
                                 levels = c(3,2,1), # reverse-coded
                                 labels = labellikert,
                                 ordered = FALSE)
pptengl.df$`Group leader knew the material` <- factor(pptengl.df$`Group leader knew the material`,
                                                  levels = c(1,2,3),
                                                  labels = labellikert,
                                                  ordered = FALSE)
pptengl.df$`I understood the material` <- factor(pptengl.df$`I understood the material`,
                                             levels = c(1,2,3),
                                             labels = labellikert,
                                             ordered = FALSE )
pptengl.df$`Group leader made the activities fun` <- factor(pptengl.df$`Group leader made the activities fun`,
                                                        levels = c(1,2,3),
                                                        labels = labellikert,
                                                        ordered = FALSE)
pptengl.df$`I felt free to speak` <- factor(pptengl.df$`I felt free to speak`,
                                        levels = c(1,2,3),
                                        labels = labellikert,
                                        ordered = FALSE)
pptengl.df$`I felt uncomfortable participating*` <- factor(pptengl.df$`I felt uncomfortable participating`,
                                                      levels = c(3,2,1), # reverse-coded
                                                      labels = labellikert,
                                                      ordered = FALSE)

#Spanish Post-Test: Categorical variable - Satisfaction
pptspan.df$`Group leader understood me` <- factor(pptspan.df$`Group leader understood me`,
                                              levels = c(1,2,3),
                                              labels = labellikert,
                                              ordered = FALSE)
pptspan.df$`Group mates respect each other` <- factor(pptspan.df$`Group mates respect each other`,
                                              levels = c(1,2,3),
                                              labels = labellikert,
                                              ordered = FALSE)
pptspan.df$`I felt judged*` <- factor(pptspan.df$`I felt judged`,
                                 levels = c(3,2,1), # reverse-coded
                                 labels = labellikert,
                                 ordered = FALSE)
pptspan.df$`Group leader knew the material` <- factor(pptspan.df$`Group leader knew the material`,
                                                  levels = c(1,2,3),
                                                  labels = labellikert,
                                                  ordered = FALSE)
pptspan.df$`I understood the material` <- factor(pptspan.df$`I understood the material`,
                                             levels = c(1,2,3),
                                             labels = labellikert,
                                             ordered = FALSE )
pptspan.df$`Group leader made the activities fun` <- factor(pptspan.df$`Group leader made the activities fun`,
                                                        levels = c(1,2,3),
                                                        labels = labellikert,
                                                        ordered = FALSE)
pptspan.df$`I felt free to speak` <- factor(pptspan.df$`I felt free to speak`,
                                        levels = c(1,2,3),
                                        labels = labellikert,
                                        ordered = FALSE)
pptspan.df$`I felt uncomfortable participating*` <- factor(pptspan.df$`I felt uncomfortable participating`,
                                                      levels = c(3,2,1), # reverse-coded
                                                      labels = labellikert,
                                                      ordered = FALSE)

# Merge the identical but parallel English and Spanish datasets
ppt.df <- rbind(pptengl.df, pptspan.df) #including blanks

########################
# Pre-Test: Experience #
########################

#Pre/Post Test by group if group name is exact (Update thisgroup name and ggsave file name below):
thisgroup <- "achd11"

library(likert)
gpexperlkt.df <- ppt.df[ppt.df$`Group Name` %like% thisgroup & ppt.df$Time=="Before",c(28:33)] #6 Experience variables (likert)
gpexperlkt.df <- na.omit(gpexperlkt.df) 

experiencelkt <- likert(items=gpexperlkt.df)
plot(experiencelkt, positive.order = TRUE) + ggtitle("Participants' Past Sexual Experiences")
ggsave("ACHD110821 - Experiences - Pre.png", width = 9, height = 2.5)

########################

#Optional: subset the types of past sexual experiences

gpexpermrd.df <- ppt.df[ppt.df$`Group Name` %like% thisgroup & ppt.df$Time=="Before",c(34,36:47)] #13 Experience options (MR dummy excluding duplicate column and "Other method" (text))
#how to make a frequency table of mrd?

never <- sum(gpexpermrd.df$`Never had sex`)
nobarr <- sum(gpexpermrd.df$`Sex with no barrier method`)
nobc <- sum(gpexpermrd.df$`Sex with no birth control`)
ec <- sum(gpexpermrd.df$EC)
iud <- sum(gpexpermrd.df$IUD)
implant <- sum(gpexpermrd.df$Implant)
shot <- sum(gpexpermrd.df$Shot)
ring <- sum(gpexpermrd.df$Ring)
patch <- sum(gpexpermrd.df$Patch)
pill <- sum(gpexpermrd.df$Pill)
barr <- sum(gpexpermrd.df$`Barrier Method`)
notsure <- sum(gpexpermrd.df$`Not sure`)

#lastsex <- rbind.data.frame(never,nobarr,nobc, ec,iud,implant,shot,ring,patch,pill,barr,notsure)
#names(lastsex) <- c("Count")
#library(sjPlot)
#tab_df(gpexpermrd.df,
#       title = "Last Sex",
#       file = "ACHD110821 - Last Sex Table.doc")

#install.packages("ggpbr")
#ggpubr::ggsummarystats(ptexperlkt.df)
#experct <- summary(experiencelkt)

#dotchart(as.matrix(mrdumlastsex,labels = row.names(mrdumlastsex)))

#https://www.youtube.com/watch?v=vQsdJBm0fLw
#mrdumlastsex <- data.frame(Freq=colSums(ptexpermrd.df[2:14]),
#                           Percent=(colSums(ptexpermrd.df[2:14])/nrow(ptexpermrd.df[2:14]))*100) 
#mrdumlastsex <- mrdumlastsex[order(-mrdumlastsex$Freq),] #sorted, but won't plot in this order

#library(ggpubr)
#ggballoonplot(mrdumlastsex, fill = "value") + scale_fill_viridis_c(option = "C")

#ggplot(mrdumlastsex, aes(x=Percent, y=rownames(mrdumlastsex))) +
#  geom_point(size = 1.5, alpha = .3) +
#  labs(title = "Contraception Use at Last Sexual Activity") +
#         theme_minimal() +
#  theme(axis.title = element_blank(),
#              panel.grid.major.x = element_blank(),
#              panel.grid.minor = element_blank(),
#              plot.title = element_text(size = 20, margin = margin(b = 10)),
#              plot.subtitle = element_text(size = 10, color = "darkslategrey", margin = margin(b = 25)),
#              plot.caption = element_text(size = 8, margin = margin(t = 10), color = "grey70", hjust = 0))
#ggsave("Test.png")

###########################
# Pre/Post-Test: Thoughts #
###########################
gpthoughts.df <- ppt.df[ppt.df$`Group Name` %like% thisgroup,c(100,4,6,95:99)] #5 Thought variables (likert) for Pre AND Post
gpthoughts.df <- na.omit(gpthoughts.df) 

thoughtlkt <- likert(gpthoughts.df[,4:8], grouping = gpthoughts.df$Time)
plot(thoughtlkt, group.order = c("Before","After")) + ggtitle("Participants' Thoughts about Future Sexual Activity")
ggsave("ACHD110821 - Thoughts over time.png", width = 9, height = 4.5)
#may not plot if too many listwise deletions

#Optional: just the pre-test thoughts
thoughtlkt <- likert(gpthoughts.df[,4:8])
plot(thoughtlkt) + ggtitle("Participants' Thoughts about Future Sexual Activity")
ggsave("ACHD110821 - Thoughts over time.png", width = 9, height = 2.5)
#may not plot if too many listwise deletions

###########################
# Post-Test: Satisfaction #
###########################

gpsatisfaction.df <- ppt.df[ppt.df$`Group Name`==thisgroup & ppt.df$Time=="After",c(100,49:56)] #8 Group variables on Post, excluding comments
gpsatisfaction.df <- na.omit(gpsatisfaction.df)

satisflkt <- likert(gpsatisfaction.df[,2:9])
plot(satisflkt) + ggtitle("Participants' Satisfaction with the Group")
ggsave("PAYC071221 - Satisfaction.png", width = 9, height = 3.25)

######################
# SurveyMonkey Stats #
######################

# Optional subsets:
#post.df <- ppt.df[ppt.df$Time=="After", c(1:3,47:60,61:97)]# optional subset of identifiers, satisfaction, contact info to post-test
#pre.df  <- ppt.df[ppt.df$Time=="Before", c(1,3,4,6:13,15,16,18:22,24,26:45)] #optional subset of demographics, experiences
#pre.df  <- na.omit(pre.df)
ptksa.df <- ppt.df[ppt.df$`Group Name`%like% thisgroup,c(100,4,63:94)] #16 KSA variables with 32 options

###############
# Eval Report #
###############
#Subsets by time frame: Update begin & finish dates below instead of IO
begin <- "2021-07-01" 
#options: "2020-07-01", "2021-01-01", "2021-07-01", "2022-01-01", "2022-07-01", "2023-01-01"
finish <- "2022-06-30" 
#options: "2020-12-31", "2021-06-30", "2021-12-31", "2022-06-30", "2022-12-31", "2023-06-30"

yrptdemographics.df <- ppt.df[ppt.df$`Start Date` >=begin & ppt.df$`Start Date`<=finish & ppt.df$Time=="Before",c(100,4,9:15,17,18,20:24,26)] #8 Demographic variables 

# install.packages("eeptools")
library(eeptools)
yrptdemographics.df$Age <- floor(age_calc(yrptdemographics.df$Birthdate, units = "years")) #make sure your date variable is formatted; does not like NAs

yrptdemographics.df$gender_cat <- apply(yrptdemographics.df[12:16], 1, function(x) {ifelse(sum(x) > 1, "Multigender", names(x[x != 0]))})
gender <- data.frame(table(yrptdemographics.df$gender_cat))
names(gender) <- c("Demographics","Count")

yrptdemographics.df$race_cat <- apply(yrptdemographics.df[4:9], 1, function(x) {ifelse(sum(x) > 1, "Multiracial", names(x[x != 0]))})
race <- data.frame(table(yrptdemographics.df$race_cat))
names(race) <- c("Demographics","Count")

age <- data.frame(table(yrptdemographics.df$Age))
names(age) <- c("Demographics","Count")

grade <- data.frame(table(yrptdemographics.df$Grade))
names(grade) <- c("Demographics","Count")

reach <- rbind.data.frame(gender,race,age,grade)
table(yrptdemographics.df$Hispanic)

library(sjPlot)
tab_df(reach,
       title = "Reach for Year 2",
       file = "Year 2 - Demographics Table.doc")
yroahrace <- tab_xtab(var.row = yrptdemographics.df$race_cat, var.col = yrptdemographics.df$Hispanic,
         title = "Race by Ethnicity for: 2022-2022",
         file = "2021-2022 - OAH Race by Ethnicity Table.doc") #may not print if no Hispanic YP

################################################

library(likert)
yrptexperlkt.df <- ppt.df[ppt.df$`Start Date` >=begin & ppt.df$`Start Date` <=finish & ppt.df$Time=="Before",c(28:33)] #6 Experience variables (likert)
yrptexperlkt.df <- na.omit(yrptexperlkt.df) 

yrexperiencelkt <- likert(items=yrptexperlkt.df)
plot(yrexperiencelkt, positive.order = TRUE) + ggtitle("Participants' Past Sexual Experiences")
ggsave("Year 1 - Experiences - Pre.png", width = 9, height = 2.5)

################################################

#compute the average pre-test score to use as a threshold against the average post-test score in a one-sample t test

rawpre.df <- read.csv("QuizSummaryYR1pre.csv")
yrpre.df <- rawpre.df[2:nrow(rawpre.df),c(2)] 

meanpre <- mean(as.numeric(sub("%","",yrpre.df))) 

rawpost.df <- read.csv("QuizSummaryYR1post.csv")
yrpost.df <- rawpost.df[2:nrow(rawpost.df),c(2)] 
yrpost.df <- as.numeric(sub("%","",yrpost.df))

t.test(yrpost.df, mu = meanpre, alternative = "greater")
library(effectsize)
cohens_d(yrpost.df, mu = meanpre, alternative = "greater")
length(yrpost.df)
length(yrpre.df)

################################################
       
yrptthoughts.df <- ppt.df[ppt.df$`Start Date`>=begin & ppt.df$`Start Date`<=finish,c(100,4,6,95:99)] #5 Thought variables (likert) for Pre AND Post
yrptthoughts.df <- na.omit(yrptthoughts.df) 
library(likert)
yrthoughtlkt <- likert(yrptthoughts.df[,4:8], grouping = yrptthoughts.df$Time)
tab_xtab(var.row=yrthoughtlkt, var.col = yrptthoughts.df$Time)
oahrace <- tab_xtab(var.row = ptdemographics.df$race_cat, var.col = ptdemographics.df$Hispanic,
         title = "Race by Ethnicity for: DreamCenter062121",
         file = "DreamCenter062121 - OAH Race by Ethnicity Table.doc") #may not print if no Hispanic YP

plot(yrthoughtlkt, group.order = c("Before","After")) + ggtitle("Participants' Thoughts about Future Sexual Activity")
ggsave("Year 1 - Thoughts over time.png", width = 9, height = 4.5)
#may not plot if too many listwise deletions

table(yrptthoughts.df$Time)

chisq.test(yrptthoughts.df$`Prepared to say no if not ready`,yrptthoughts.df$Time)
chisq.test(yrptthoughts.df$`Prepared to use a barrier method`,yrptthoughts.df$Time)
chisq.test(yrptthoughts.df$`Prepared to say no if no barrier method`,yrptthoughts.df$Time)
chisq.test(yrptthoughts.df$`Prepared to use birth control`,yrptthoughts.df$Time)
chisq.test(yrptthoughts.df$`Prepared to go to a doctor for birth control`,yrptthoughts.df$Time)

################################################

yrptsatisfaction.df <- ppt.df[ppt.df$`Start Date`>=begin & ppt.df$`Start Date`<=finish & ppt.df$Time=="After",c(100,49:56)] #8 Group variables on Post
yrptsatisfaction.df <- na.omit(yrptsatisfaction.df)

yrsatisflkt <- likert(yrptsatisfaction.df[,2:9])
plot(yrsatisflkt) + ggtitle("Participants' Satisfaction with the Group")
ggsave("Year 1 - Satisfaction.png", width = 9, height = 3.25)

################
# OAH 1: Reach #
################

gpdemographics.df <- ppt.df[ppt.df$`Group Name` %like% thisgroup & ppt.df$Time=="Before",c(4,100,3,9:15,17,18,20:24,26)] #8 Demographic variables 
gpdemographics.df <- na.omit(gpdemographics.df)

# install.packages("eeptools")
library(eeptools)
gpdemographics.df$Age <- floor(age_calc(gpdemographics.df$Birthdate, units = "years")) #make sure your date variable is formatted; does not like NAs

gpdemographics.df$gender_cat <- apply(gpdemographics.df[13:17], 1, function(x) {ifelse(sum(x) > 1, "Multigender", names(x[x != 0]))})
gender <- data.frame(table(gpdemographics.df$gender_cat))
names(gender) <- c("Demographics","Count")

gpdemographics.df$race_cat <- apply(gpdemographics.df[5:10], 1, function(x) {ifelse(sum(x) > 1, "Multiracial", names(x[x != 0]))})
race <- data.frame(table(gpdemographics.df$race_cat))
names(race) <- c("Demographics","Count")

age <- data.frame(table(gpdemographics.df$Age))
names(age) <- c("Demographics","Count")

grade <- data.frame(table(gpdemographics.df$Grade))
names(grade) <- c("Demographics","Count")

reach <- rbind.data.frame(gender,race,age,grade)

library(sjPlot)
tab_df(reach,
       title = "Reach for: ACHD110821",
       file = "ACHD110821 - Demographics Table.doc")
oahrace <- tab_xtab(var.row = gpdemographics.df$race_cat, var.col = gpdemographics.df$Hispanic,
         title = "Race by Ethnicity for: ACHD110821",
         file = "ACHD110821 - OAH Race by Ethnicity Table.doc") #may not print if no Hispanic YP
table(gpdemographics.df$race_cat,gpdemographics.df$Hispanic)
#Knitr can print double tables: https://bookdown.org/yihui/rmarkdown-cookbook/kable.html#multiple-tables-side-by-side
#knitr::kables(
#  list(
#    knitr::kable(
#      reach),
#    knitr::kable(oahrace)),)
```
# Fidelity Logs & Quarterly Program Reports
- import all responses (as *.csv & numeric values)
- name the variables/columns
- replace the blanks with missing (NA)
- lowercase the strings (i.e., group names)
- format the dates
- convert the "Check all that apply" into dummy variables
- factor the categorical variables
- subset the scales
- append the long form data
- table & save
```{r}
rawflqpr.df <- read.csv("Facilitators Evaluation Tools.csv", stringsAsFactors = TRUE)
flqpr.df <- rawflqpr.df[2:nrow(rawflqpr.df),c(10:30,32:36,38:47,49:53,55:64,66:70,72:81,83:87,89:93,95:99,101:105,107,115:121,141:153,155:167,169:181,183:195,196)] #145 variables
names(flqpr.df) <- c("tool",
                    "FL io",
                    "FL grp",
                    "FL fac1", "FL fac2", "FL fac3", "FL TA topic",
                    "FL success",
                    "FL ref srh","FL ref mh","FL ref sa","FL ref pcp","FL ref edu","FL ref voc","FL ref viol",
                    "FL ebp",
                    "LN1 name","LN1 start","LN1 how","LN1 change","LN1 incomp",
                    "LN2 name","LN2 start","LN2 how","LN2 change","LN2 incomp",
                    "LN3 name","LN3 start","LN3 how","LN3 change","LN3 incomp",
                    "MPC1 name","MPC1 start","MPC1 how","MPC1 change","MPC1 incomp",
                    "MPC2 name","MPC2 start","MPC2 how","MPC2 change","MPC2 incomp",
                    "MPC3 name","MPC3 start","MPC3 how","MPC3 change","MPC3 incomp",
                    "IN1 name","IN1 start","IN1 how","IN1 change","IN1 incomp",
                    "IN2 name","IN2 start","IN2 how","IN2 change","IN2 incomp",
                    "IN3 name","IN3 start","IN3 how","IN3 change","IN3 incomp",
                    "SL1 name","SL1 start","SL1 how","SL1 change","SL1 incomp",
                    "SL2 name","SL2 start","SL2 how","SL2 change","SL2 incomp",
                    "SL3 name","SL3 start","SL3 how","SL3 change","SL3 incomp",
                    "SL4 name","SL4 start","SL4 how","SL4 change","SL4 incomp",
                    "SL5 name","SL5 start","SL5 how","SL5 change","SL5 incomp",
                    "QPR fac", "QPR email", "QPR phone", "QPR io", "QPR setting", "QPR prog spec", "QPR period", "QPR ebp",
                    "QPR1 name","# meetings","QPR1 start","QPR1 end","QPR1 change","QPR1 reach","QPR1 attend","QPR1 retent","QPR1 eval-none","QPR1 eval-pre","QPR1 eval-FL","QPR1 eval-obs","QPR1 eval-post",
                    "QPR2 name","# meetings","QPR2 start","QPR2 end","QPR2 change","QPR2 reach","QPR2 attend","QPR2 retent","QPR2 eval-none","QPR2 eval-pre","QPR2 eval-FL","QPR2 eval-obs","QPR2 eval-post",
                    "QPR3 name","# meetings","QPR3 start","QPR3 end","QPR3 change","QPR3 reach","QPR3 attend","QPR3 retent","QPR3 eval-none","QPR3 eval-pre","QPR3 eval-FL","QPR3 eval-obs","QPR3 eval-post",
                    "QPR4 name","# meetings","QPR4 start","QPR4 end","QPR4 change","QPR4 reach","QPR4 attend","QPR4 retent","QPR4 eval-none","QPR4 eval-pre","QPR4 eval-FL","QPR4 eval-obs","QPR4 eval-post",
                    "add'l info")
flqpr.df[flqpr.df==""] <- NA

library(data.table)
flqpr.df$`FL grp`<- tolower(flqpr.df$`FL grp`)
flqpr.df$`QPR1 name` <- tolower(flqpr.df$`QPR1 name`)
flqpr.df$`QPR2 name` <- tolower(flqpr.df$`QPR2 name`)
flqpr.df$`QPR3 name` <- tolower(flqpr.df$`QPR3 name`)
flqpr.df$`QPR4 name` <- tolower(flqpr.df$`QPR4 name`)

flqpr.df$`MPC1 start` <- as.Date(flqpr.df$`MPC1 start`,"%m/%d/%Y")
flqpr.df$`MPC2 start` <- as.Date(flqpr.df$`MPC2 start`,"%m/%d/%Y")
flqpr.df$`MPC3 start` <- as.Date(flqpr.df$`MPC3 start`,"%m/%d/%Y")

flqpr.df$`IN1 start` <- as.Date(flqpr.df$`IN1 start`,"%m/%d/%Y")
flqpr.df$`IN2 start` <- as.Date(flqpr.df$`IN2 start`,"%m/%d/%Y")
flqpr.df$`IN3 start` <- as.Date(flqpr.df$`IN3 start`,"%m/%d/%Y")

flqpr.df$`SL1 start` <- as.Date(flqpr.df$`SL1 start`,"%m/%d/%Y")
flqpr.df$`SL2 start` <- as.Date(flqpr.df$`SL2 start`,"%m/%d/%Y")
flqpr.df$`SL3 start` <- as.Date(flqpr.df$`SL3 start`,"%m/%d/%Y")
flqpr.df$`SL4 start` <- as.Date(flqpr.df$`SL4 start`,"%m/%d/%Y")
flqpr.df$`SL5 start` <- as.Date(flqpr.df$`SL5 start`,"%m/%d/%Y")

flqpr.df$`QPR1 start` <- as.Date(flqpr.df$`QPR1 start`,"%m/%d/%Y")
flqpr.df$`QPR2 start` <- as.Date(flqpr.df$`QPR2 start`,"%m/%d/%Y")
flqpr.df$`QPR3 start` <- as.Date(flqpr.df$`QPR3 start`,"%m/%d/%Y")
flqpr.df$`QPR4 start` <- as.Date(flqpr.df$`QPR4 start`,"%m/%d/%Y")

flqpr.df$`QPR1 end` <- as.Date(flqpr.df$`QPR1 end`,"%m/%d/%Y")
flqpr.df$`QPR2 end` <- as.Date(flqpr.df$`QPR2 end`,"%m/%d/%Y")
flqpr.df$`QPR3 end` <- as.Date(flqpr.df$`QPR3 end`,"%m/%d/%Y")
flqpr.df$`QPR4 end` <- as.Date(flqpr.df$`QPR4 end`,"%m/%d/%Y")

cleanIt <- function(vec){
  chars <- as.character(vec)
  chars[chars!=""] <- "1" #if not blank (including zeroes), replace with "one"
  chars[is.na(chars)] <- "0" #if missing, replace with zero
  chars[chars==""] <- "0" #if blank, replace with zero
  return(as.numeric(chars)) #convert values to numbers
}

flqpr.df[103:107] <- lapply(flqpr.df[103:107], cleanIt) #QPR1 eval
flqpr.df[116:120] <- lapply(flqpr.df[116:120], cleanIt) #QPR2 eval
flqpr.df[129:133] <- lapply(flqpr.df[129:133], cleanIt) #QPR3 eval
flqpr.df[142:146] <- lapply(flqpr.df[142:146], cleanIt) #QPR4 eval

labelio <- c("ACDSS","ACHD","CHS","DreamCenter","CrossRoads","Elon","PAYC","SA")
labelepb <- c("HF-NC","IN-clued","Love Notes","MPC","PPP","SSI","Supplementals")
labelln <- c("N&B","1","2","3","4","5","6","7","8","9","10","11","12","13","KTA")
labelmpc <- c("N&B","1","2","3","EC","TMHYLI","4","5","6","7","8","9","10","KTA")
labelinc <- c("N&B1-2","1","N&B3","2","3","KTA")
labelsl <- c("KTA1","KTA2","KTA3","TMHYLI1","TMHYLI2","TMHYLI3","TMHYLI4","TMHYLI5")
labelhow <- c("as written","with changes","incomplete")
labelset <- c("school","other CBO","out-of-home","homeless","juvenile justice","clinic","faith-based")
labelperiod <- c("Y1-SAPR1","Y1-SAPR1","Y1-SAPR2","Y1-SAPR2","Y2-SAPR1","Y2-SAPR1","Y2-SAPR2","Y2-SAPR2","Y3-SAPR1","Y3-SAPR1","Y3-SAPR2","Y3-SAPR2")

flqpr.df$tool <- factor(flqpr.df$tool,
                          levels = c(1,2,3),
                          labels = c("P/PT","FL","QPR"))
flqpr.df$`FL io` <- factor(flqpr.df$`FL io`,
                          levels = c(1,2,3,4,5,6,7,8),
                          labels = labelio)
flqpr.df$`FL ebp` <- factor(flqpr.df$`FL ebp`,
                           levels = c(1,2,3,4,5,6,7),
                           labels = labelepb)

#Fidelity Logs: lesson names for MPC & IN-clued only
flqpr.df$`MPC1 name` <- factor(flqpr.df$`MPC1 name`,
                              levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14),
                              labels = labelmpc)
flqpr.df$`MPC2 name` <- factor(flqpr.df$`MPC2 name`,
                              levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14),
                              labels = labelmpc)
flqpr.df$`MPC3 name` <- factor(flqpr.df$`MPC3 name`,
                              levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14),
                              labels = labelmpc)

flqpr.df$`IN1 name` <- factor(flqpr.df$`IN1 name`,
                             levels = c(1,2,3,4,5,6),
                             labels = labelinc)
flqpr.df$`IN2 name` <- factor(flqpr.df$`IN2 name`,
                             levels = c(1,2,3,4,5,6),
                             labels = labelinc)
flqpr.df$`IN3 name` <- factor(flqpr.df$`IN3 name`,
                             levels = c(1,2,3,4,5,6),
                             labels = labelinc)

#Fidelity Logs: lesson implementation for all EBPs with Fidelity Logs
flqpr.df$`LN1 how` <- factor(flqpr.df$`LN1 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`LN2 how` <- factor(flqpr.df$`LN2 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`LN3 how` <- factor(flqpr.df$`LN3 how`,
                            levels = c(1,2,3),
                            labels = labelhow)

flqpr.df$`MPC1 how` <- factor(flqpr.df$`MPC1 how`,
                             levels = c(1,2,3),
                             labels = labelhow)
flqpr.df$`MPC2 how` <- factor(flqpr.df$`MPC2 how`,
                             levels = c(1,2,3),
                             labels = labelhow)
flqpr.df$`MPC3 how` <- factor(flqpr.df$`MPC3 how`,
                             levels = c(1,2,3),
                             labels = labelhow)

flqpr.df$`IN1 how` <- factor(flqpr.df$`IN1 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`IN2 how` <- factor(flqpr.df$`IN2 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`IN3 how` <- factor(flqpr.df$`IN3 how`,
                            levels = c(1,2,3),
                            labels = labelhow)

flqpr.df$`SL1 how` <- factor(flqpr.df$`SL1 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`SL2 how` <- factor(flqpr.df$`SL2 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`SL3 how` <- factor(flqpr.df$`SL3 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`SL4 how` <- factor(flqpr.df$`SL4 how`,
                            levels = c(1,2,3),
                            labels = labelhow)
flqpr.df$`SL5 how` <- factor(flqpr.df$`SL5 how`,
                            levels = c(1,2,3),
                            labels = labelhow)

#Quarterly Program Reports
flqpr.df$`QPR io` <- factor(flqpr.df$`QPR io`,
                                   levels = c(1,2,3,4,5,6,7,8),
                                   labels = labelio)
flqpr.df$`QPR setting` <- factor(flqpr.df$`QPR setting`,
                                   levels = c(1,2,3,4,5,6,7),
                                   labels = labelset)
flqpr.df$`QPR prog spec` <- factor(flqpr.df$`QPR prog spec`,
                                   levels = c(1,2),
                                   labels = c("Lisa","Caro"))
flqpr.df$`QPR period` <- factor(flqpr.df$`QPR period`,
                                   levels = c(1,2,3,4,5,6,7,8,9,10,11,12),
                                   labels = labelperiod)
flqpr.df$`QPR ebp` <- factor(flqpr.df$`QPR ebp`,
                                   levels = c(1,2,3,4,5,6,7),
                                   labels = labelepb)

#######################
# OAH 2: Dosage (all) #
#######################
#double check column numbers
#Reach & Retention by group reported in the QPR; convert to wide form to long form data
period <- "Y1-SAPR2"  #options: "Y1-SAPR1", "Y1-SAPR2", "Y2-SAPR1", "Y2-SAPR2", "Y3-SAPR1", "Y3-SAPR2",
curr <- "MPC" #options:" "MPC", "IN-clued"

qpr1 <- flqpr.df[flqpr.df$`QPR period` %like% period & flqpr.df$`QPR ebp`==curr, c(95,96,100:102)]
qpr2 <- flqpr.df[flqpr.df$`QPR period` %like% period & flqpr.df$`QPR ebp`==curr, c(108,109,113:115)]
qpr3 <- flqpr.df[flqpr.df$`QPR period` %like% period & flqpr.df$`QPR ebp`==curr, c(121,122,126:128)]
qpr4 <- flqpr.df[flqpr.df$`QPR period` %like% period & flqpr.df$`QPR ebp`==curr, c(134,135,139:141)]

names(qpr1) <- c("Group Name","# Sessions/Meetings","Reach","Average Attendance","Retention")
names(qpr2) <- c("Group Name","# Sessions/Meetings","Reach","Average Attendance","Retention")
names(qpr3) <- c("Group Name","# Sessions/Meetings","Reach","Average Attendance","Retention")
names(qpr4) <- c("Group Name","# Sessions/Meetings","Reach","Average Attendance","Retention")

dosage <- rbind.data.frame(qpr1,qpr2,qpr3,qpr4)
dosage <- na.omit(dosage)

library(sjPlot)
tab_df(dosage,
       title = "Dosage for MPC: 2020-2021",
       file = "MPC 2020-2021 - Dosage Table.doc")

#repeat for IN-clued

################################################
# OAH 3: Fidelity & Quality: Lessons Completed #
################################################
#Subsets by time frame: Update begin & finish dates below
begin  <- "2021-01-01" #options: "2020-07-01", "2021-01-01", "2021-07-01", "2022-01-01", "2022-07-01", "2023-01-01"
finish <- "2021-06-30" #options: "2020-12-31", "2021-06-30", "2021-12-31", "2022-06-30", "2022-12-31", "2023-06-30"

saprfl.df <- flqpr.df[flqpr.df$`MPC1 start` >=begin & flqpr.df$`MPC1 start` <=finish, c(1:147)]

table(saprfl.df$`FL grp`,saprfl.df$`FL ebp`) 
#How many sections/groups have fidelity logs? How many logs per section/group? For which EBP? Technically, this is the lessons completed. 
#Doesn't seem to match this dataframe of all FLs for the year:

mpc1 <- flqpr.df[flqpr.df$`MPC1 start` >=begin & flqpr.df$`MPC1 start` <=finish,c(3,32:36)]
mpc2 <- flqpr.df[flqpr.df$`MPC2 start` >=begin & flqpr.df$`MPC2 start` <=finish,c(3,37:41)]
mpc3 <- flqpr.df[flqpr.df$`MPC3 start` >=begin & flqpr.df$`MPC3 start` <=finish,c(3,42:46)]

names(mpc1) <- c("FL Group", "Lesson Name", "Start Date", "MPC Implementation", "Changes Made","Incomplete")
names(mpc2) <- c("FL Group", "Lesson Name", "Start Date", "MPC Implementation", "Changes Made","Incomplete")
names(mpc3) <- c("FL Group", "Lesson Name", "Start Date", "MPC Implementation", "Changes Made","Incomplete")

mpcflall <- rbind.data.frame(mpc1,mpc2,mpc3)
mpcflall <- na.omit(mpcflall)

#Optional: Double check by group, using the appended logs below by EBP

#Append the MPC lesson logs into a long form fidelity log, by group/section:
mpcgrp <- "dreamcenter032421"

mpc1 <- flqpr.df[flqpr.df$`FL grp` %like% mpcgrp,c(3,32:36)]
mpc2 <- flqpr.df[flqpr.df$`FL grp` %like% mpcgrp,c(3,37:41)]
mpc3 <- flqpr.df[flqpr.df$`FL grp` %like% mpcgrp,c(3,42:46)]

names(mpc1) <- c("FL Group", "Lesson Name", "Start Date", "MPC Implementation", "Changes Made","Incomplete")
names(mpc2) <- c("FL Group", "Lesson Name", "Start Date", "MPC Implementation", "Changes Made","Incomplete")
names(mpc3) <- c("FL Group", "Lesson Name", "Start Date", "MPC Implementation", "Changes Made","Incomplete")

mpcfl <- rbind.data.frame(mpc1,mpc2,mpc3)
mpcfl <- na.omit(mpcfl)

#Append the IN-clued lesson logs into a long form fidelity log, by group/section:
incgrp <- "dreamcenter062121"

inc1 <- flqpr.df[flqpr.df$`FL grp`==incgrp,c(3,47:51)]
inc2 <- flqpr.df[flqpr.df$`FL grp`==incgrp,c(3,52:56)]
inc3 <- flqpr.df[flqpr.df$`FL grp`==incgrp,c(3,57:61)]

names(inc1) <- c("FL Group", "Lesson Name", "Start Date", "IN-clued Implementation", "Changes Made","Incomplete")
names(inc2) <- c("FL Group", "Lesson Name", "Start Date", "IN-clued Implementation", "Changes Made","Incomplete")
names(inc3) <- c("FL Group", "Lesson Name", "Start Date", "IN-clued Implementation", "Changes Made","Incomplete")

incfl <- rbind.data.frame(inc1,inc2,inc3)
incfl <- na.omit(incfl)

###########################################
# OAH 3: Fidelity & Quality: Observations #
###########################################

rawobs.df <- read.csv("OAH Program Observation Form for TPP Grantees.csv", stringsAsFactors = TRUE)
obs.df <- rawobs.df[2:nrow(rawobs.df),c(11,20,23,22,21,34)]
names(obs.df) <- c("Group observed",
                   "Date observed",
                   "observed_activities",
                   "total_activities",
                   "# Lessons observed",
                   "Observation Quality")
obs.df[obs.df==""] <- NA

library(data.table)
obs.df$`Group observed`<- tolower(obs.df$`Group observed`)

obs.df$`Date observed` <- as.Date(obs.df$`Date observed`,"%m/%d/%Y")

cleanCares <- function(vec){
  chars <- as.character(vec)
  chars[is.na(chars)] <- "0" #if missing, replace with zero
  chars[chars==""] <- "0" #if blank, replace with zero
  return(as.numeric(chars)) #convert values to numbers
}

obs.df[3:6] <- lapply(obs.df[3:6], cleanCares)

obs.df$adherence <- obs.df$observed_activities / obs.df$total_activities *100

obs.df <- obs.df[obs.df$`Date observed` >=begin & obs.df$`Date observed` <=finish, c(1:7)]

library(knitr)
kable(obs.df)

#need to figure out table

##############################
# OAH 4: Supportive Services #
##############################

#subset by period:
referralsall.df <- flqpr.df[flqpr.df$`MPC1 start` >=begin & flqpr.df$`MPC1 start` <=finish,c(3,9:15)] 
referralsall.df <- na.omit(referralsall.df)

#subset by service:
referralsall.df$`FL ref edu` <- as.numeric(as.character(referralsall.df$`FL ref edu`))
referralsall.df$`FL ref mh` <- as.numeric(as.character(referralsall.df$`FL ref mh`))
referralsall.df$`FL ref pcp` <- as.numeric(as.character(referralsall.df$`FL ref pcp`))
referralsall.df$`FL ref sa` <- as.numeric(as.character(referralsall.df$`FL ref sa`))
referralsall.df$`FL ref srh` <- as.numeric(as.character(referralsall.df$`FL ref srh`))
referralsall.df$`FL ref viol` <- as.numeric(as.character(referralsall.df$`FL ref viol`))
referralsall.df$`FL ref voc` <- as.numeric(as.character(referralsall.df$`FL ref voc`))

#sum each service
edu <- sum(referralsall.df$`FL ref edu`)
mh <- sum(referralsall.df$`FL ref mh`)
pcp <- sum(referralsall.df$`FL ref pcp`)
sa <- sum(referralsall.df$`FL ref sa`)
srh <- sum(referralsall.df$`FL ref srh`)
viol <- sum(referralsall.df$`FL ref viol`)
voc <- sum(referralsall.df$`FL ref voc`)

#create a new dataframe with the sums
suppsrvs <- data.frame(referral=c("SRH","MH","SA","PCP","EDU","VOC","VIOL"),count=c(srh,mh,sa,pcp,edu,voc,viol))

#create a table with all referrals total (for SAPR)
tab_df(suppsrvs,
       title = "Y1 Referrals for all IOs",
       file = "Y1 Referrals Table - all IOs.doc")

#subset by IO & period:
org <- "SA" #options: "ACDSS", "CHS", "DreamCenter", PAYC", "SA"
referrals.df <- flqpr.df[flqpr.df$`FL io` %like% org & flqpr.df$`MPC1 start` >=begin & flqpr.df$`MPC1 start` <=finish,c(3,9:15)] 
referrals.df <- na.omit(referrals.df)

#subset by service:
referrals.df$`FL ref edu` <- as.numeric(as.character(referrals.df$`FL ref edu`))
referrals.df$`FL ref mh` <- as.numeric(as.character(referrals.df$`FL ref mh`))
referrals.df$`FL ref pcp` <- as.numeric(as.character(referrals.df$`FL ref pcp`))
referrals.df$`FL ref sa` <- as.numeric(as.character(referrals.df$`FL ref sa`))
referrals.df$`FL ref srh` <- as.numeric(as.character(referrals.df$`FL ref srh`))
referrals.df$`FL ref viol` <- as.numeric(as.character(referrals.df$`FL ref viol`))
referrals.df$`FL ref voc` <- as.numeric(as.character(referrals.df$`FL ref voc`))

#sum each service
edu <- sum(referrals.df$`FL ref edu`)
mh <- sum(referrals.df$`FL ref mh`)
pcp <- sum(referrals.df$`FL ref pcp`)
sa <- sum(referrals.df$`FL ref sa`)
srh <- sum(referrals.df$`FL ref srh`)
viol <- sum(referrals.df$`FL ref viol`)
voc <- sum(referrals.df$`FL ref voc`)

#create a new dataframe with the sums
suppsrvs <- data.frame(referral=c("SRH","MH","SA","PCP","EDU","VOC","VIOL"),count=c(srh,mh,sa,pcp,edu,voc,viol))

#create a table with all referrals for this IO (for OAHPMdata); change titles and file names
tab_df(suppsrvs,
       title = "Y1 Referrals for: SA",
       file = "SA - Y1 Referrals Table.doc")
```
# Alamance Cares
- import all responses (as *.csv & numeric values)
- convert the "Check all that apply" into dummy variables
- factor the categorical variables
- format the dates
- subset the scales
- name the variables/columns
- append the long form data
- table & save
```{r}
# Alamance Cares: Supportive Services
rawcares.df <- read.csv("Alamance Cares Testing Data.csv", stringsAsFactors = TRUE)
rawcares.df <- rawcares.df[2:nrow(rawcares.df),c(10:54)]

cleanCares <- function(vec){
  chars <- as.character(vec)
  chars[is.na(chars)] <- "0" #if missing, replace with zero
  chars[chars==""] <- "0" #if blank, replace with zero
  return(as.numeric(chars)) #convert values to numbers
}

rawcares.df[2:45] <- lapply(rawcares.df[2:45], cleanCares)

rawcares.df$Month <- factor(rawcares.df$Month,
                       levels = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels = c("2020-07-01","2020-08-01","2020-09-01","2020-10-01","2020-11-01","2020-12-01",
                                  "2021-01-01","2021-02-01","2021-03-01","2021-04-01","2021-05-01","2021-06-01"))

rawcares.df$Date <- as.Date(rawcares.df$Month, format = "%Y-%m-%d")

younger.df <- rawcares.df[rawcares.df$Date >=begin & rawcares.df$Date <=finish, c(2:23,46)]
older.df   <- rawcares.df[rawcares.df$Date >=begin & rawcares.df$Date <=finish, c(24:46)]

younger.df$Age <- "14-17"
older.df$Age <- "18-19"

names(younger.df) <- c("Men","Women","F2M", "M2F","Other gender","White","Black","Native","Asian", "Pacific Islander","Multiracial","Race not specified","Race unknown","Hispanic","Non Hispanic","Ethnicity Unknown","Alamance Cares","ACC","ACHD","Elon","Maplebrook","SA","Date","Age")
names(older.df) <- c("Men","Women","F2M", "M2F","Other gender","White","Black","Native","Asian", "Pacific Islander","Multiracial","Race not specified","Race unknown","Hispanic","Non Hispanic","Ethnicity Unknown","Alamance Cares","ACC","ACHD","Elon","Maplebrook","SA","Date","Age")

cares.df <- rbind(younger.df,older.df) #6 months x 2 age groups = 12 obs

#haven't figured out how to output a pub-ready table since this is already aggregated data; ended up doing counts & percents in excel
women <- aggregate(x=cares.df$Women,
                   by= list(cares.df$Age),
                   FUN=sum)
men <- aggregate(x=cares.df$Men,
          by= list(cares.df$Age),
          FUN=sum)
other <- aggregate(x=cares.df$`Other gender`,
                   by= list(cares.df$Age),
                   FUN=sum)

table1 <- rbind(women, men, other)
```